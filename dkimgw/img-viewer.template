<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Docker Inspect JSON Viewer</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      background: #f6f6f6;
    }
    h1 { font-size: 20px; margin-bottom: 10px; }
    .uploader, .search-box { margin-bottom: 12px; }
    .search-input { width: 280px; padding: 6px 8px; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; background: #fff; table-layout: fixed; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; font-size: 13px; word-break: break-all; }
    th { background: #f0f0f0; text-align: left; cursor: pointer; user-select: none; }
    th.sortable:hover { background: #e6e6e6; }
    .small { font-size: 12px; color: #666; }
    #status.load-success { color: #067d00; font-weight: 600; }
    #status.load-failed { color: #b00020; font-weight: 600; }
    .dim { color: #888; font-size: 12px; }
    th:nth-child(1), td:nth-child(1) { width: 16%; }
    th:nth-child(2), td:nth-child(2) { width: 36%; }
    th:nth-child(3), td:nth-child(3) { width: 12%; }
    th:nth-child(4), td:nth-child(4) { width: 12%; }
    th:nth-child(5), td:nth-child(5) { width: 16%; }
    .sort-indicator { margin-left: 4px; font-size: 11px; color: #555; }
    .name-tags { display: block; }
    .image-name { font-weight: 600; margin-bottom: 4px; display: block; }
    .tag-item {
      display: inline-block;
      background: #eef2ff;
      border: 1px solid #d4d4ff;
      border-radius: 3px;
      padding: 2px 6px;
      margin: 2px 6px 2px 0;
      font-size: 12px;
      white-space: normal;
    }
    mark { background: #ffe58f; padding: 0 2px; }
  </style>
  <!-- 这个就是你要替换的占位符 -->
  <script id="embeddedJson" type="application/json">__DOCKER_IMAGE_INSPECT_PLACEHOLDER__</script>
</head>
<body>
  <h1>Docker Inspect JSON Viewer</h1>
  <div class="uploader">
    <input type="file" id="fileInput" accept=".json,application/json" />
  </div>
  <div class="search-box" style="display:none;" id="searchBox">
    <input type="text" id="searchInput" class="search-input" placeholder="输入关键字过滤，支持ID/名称/标签/平台/时间..." />
  </div>
  <div id="status" class="small">请先选择一个 docker inspect 的 JSON 文件，或者生成后替换本页占位符。</div>
  <table id="resultTable" style="margin-top: 12px; display:none;">
    <thead>
      <tr>
        <th class="sortable" data-sort-key="id">镜像ID <span class="sort-indicator" data-indicator="id"></span></th>
        <th class="sortable" data-sort-key="name">镜像名称和标签 <span class="sort-indicator" data-indicator="name"></span></th>
        <th class="sortable" data-sort-key="platform">平台 <span class="sort-indicator" data-indicator="platform"></span></th>
        <th class="sortable" data-sort-key="size">大小 <span class="sort-indicator" data-indicator="size"></span></th>
        <th class="sortable" data-sort-key="created">创建时间 <span class="sort-indicator" data-indicator="created"></span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    const table = document.getElementById('resultTable');
    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th.sortable');
    const searchBox = document.getElementById('searchBox');
    const searchInput = document.getElementById('searchInput');

    let currentData = [];
    let currentSort = { key: null, dir: 'asc' };
    let currentQuery = '';

    window.addEventListener('DOMContentLoaded', () => {
      const loaded = tryLoadEmbeddedJson();
      if (!loaded) {
        // 没有内置 json，就保持初始灰色提示
      }
    });

    function tryLoadEmbeddedJson() {
      const el = document.getElementById('embeddedJson');
      if (!el) return false;
      const text = (el.textContent || '').trim();
      // 如果还是占位符，说明你还没替换
      if (!text || text === '__DOCKER_IMAGE_INSPECT_PLACEHOLDER__') return false;
      try {
        const data = JSON.parse(text);
        if (Array.isArray(data)) {
          currentData = data.map(raw => normalizeItem(raw));
          renderFilteredAndSorted();
          table.style.display = '';
          searchBox.style.display = '';
          status.textContent = `已加载内置的 docker inspect 数据，共 ${data.length} 条。`;
          status.classList.remove('load-failed');
          status.classList.add('load-success');
          return true;
        }
      } catch (err) {
        console.warn('内置 JSON 解析失败：', err);
        status.textContent = '内置 JSON 解析失败，请检查格式，或手动选择 JSON 文件。';
        status.classList.remove('load-success');
        status.classList.add('load-failed');
      }
      return false;
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const text = evt.target.result;
          const data = JSON.parse(text);
          if (!Array.isArray(data)) throw new Error('JSON 顶层不是数组');

          currentData = data.map(raw => normalizeItem(raw));
          renderFilteredAndSorted();

          status.textContent = `已加载文件：${file.name}，共 ${data.length} 条记录。`;
          status.classList.remove('load-failed');
          status.classList.add('load-success');
          table.style.display = '';
          searchBox.style.display = '';
        } catch (err) {
          console.error(err);
          status.textContent = '解析失败：' + err.message;
          status.classList.remove('load-success');
          status.classList.add('load-failed');
          table.style.display = 'none';
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    // 表头排序
    headers.forEach(th => {
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-sort-key');
        if (!key) return;

        if (currentSort.key === key) {
          currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.key = key;
          currentSort.dir = 'asc';
        }

        renderFilteredAndSorted();
        updateSortIndicators();
      });
    });

    // 搜索
    searchInput.addEventListener('input', () => {
      currentQuery = searchInput.value.trim();
      renderFilteredAndSorted();
    });

    function renderFilteredAndSorted() {
      const q = currentQuery.toLowerCase();
      let filtered = currentData;
      if (q) {
        filtered = currentData.filter(item => {
          const haystack = buildSearchText(item).toLowerCase();
          return haystack.includes(q);
        });
      }
      if (currentSort.key) {
        filtered = [...filtered].sort((a, b) => compareByKey(a, b, currentSort.key, currentSort.dir));
      }
      renderTable(filtered, currentQuery);
    }

    function buildSearchText(item) {
      return [
        item.id,
        item.name,
        item.repoTags.join(' '),
        item.platform,
        String(item.size),
        item.created
      ].join(' ');
    }

    function normalizeItem(item) {
      const repoTags = Array.isArray(item.RepoTags) ? item.RepoTags : [];
      const mainName = repoTags.length > 0 ? repoTags[0] : '';

      const platform = item.Platform ||
        (item.Os && item.Architecture ? `${item.Os}/${item.Architecture}` :
         item.Os || item.Architecture || '');

      const sizeBytes = typeof item.Size === 'number' ? item.Size : 0;

      const id = item.Id || '';
      const shortId = id.startsWith('sha256:') ? id.slice(7, 19) : id.slice(0, 12);

      const created = item.Created || '';
      const ts = parseToTimestamp(created);

      return {
        raw: item,
        repoTags,
        name: mainName,
        platform,
        size: sizeBytes,
        id,
        shortId,
        created,
        createdTs: ts
      };
    }

    function renderTable(items, query = '') {
      tbody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');

        const idShort = highlightMatch(item.shortId, query);
        const idFull = highlightMatch(item.id, query);
        const idHtml = `${idShort}<br><span class="dim">${idFull}</span>`;

        const timeParts = splitDateTime(item.created);
        const dateHtml = highlightMatch(timeParts.date, query);
        const timeHtml = highlightMatch(timeParts.time, query);
        const createdHtml = `${dateHtml}<br><span class="dim">${timeHtml}</span>`;

        const nameHtml = highlightMatch(item.name, query);
        let tagsHtml = '';
        if (item.repoTags.length > 0) {
          tagsHtml = item.repoTags.map(tag => {
            return `<span class="tag-item" title="${escapeHtml(tag)}">${highlightMatch(tag, query)}</span>`;
          }).join('');
        } else {
          tagsHtml = `<span class="dim">无标签</span>`;
        }

        tr.innerHTML = `
          <td>${idHtml}</td>
          <td>
            <div class="name-tags">
              <span class="image-name" title="${escapeHtml(item.name)}">${nameHtml}</span>
              ${tagsHtml}
            </div>
          </td>
          <td>${highlightMatch(item.platform, query)}</td>
          <td>${highlightMatch(formatBytes(item.size), query)}</td>
          <td>${createdHtml}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateSortIndicators() {
      const indicators = document.querySelectorAll('.sort-indicator');
      indicators.forEach(el => el.textContent = '');
      if (!currentSort.key) return;
      const currentInd = document.querySelector(`.sort-indicator[data-indicator="${currentSort.key}"]`);
      if (currentInd) {
        currentInd.textContent = currentSort.dir === 'asc' ? '↑' : '↓';
      }
    }

    function compareByKey(a, b, key, dir) {
      let v1, v2;
      switch (key) {
        case 'id': return stringCompare(a.id || '', b.id || '', dir);
        case 'name': return stringCompare(a.name || '', b.name || '', dir);
        case 'platform': return stringCompare(a.platform || '', b.platform || '', dir);
        case 'size': return numberCompare(a.size || 0, b.size || 0, dir);
        case 'created': return numberCompare(a.createdTs || 0, b.createdTs || 0, dir);
        default: return 0;
      }
    }

    function stringCompare(a, b, dir) {
      const res = a.localeCompare(b);
      return dir === 'asc' ? res : -res;
    }

    function numberCompare(a, b, dir) {
      const res = a - b;
      return dir === 'asc' ? res : -res;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      const value = bytes / Math.pow(k, i);
      return value.toFixed(value >= 10 ? 1 : 2) + ' ' + sizes[i];
    }

    // 本地时间 + 时区
    function splitDateTime(isoStr) {
      if (!isoStr) return { date: '', time: '' };
      const d = new Date(isoStr);
      if (isNaN(d)) {
        const parts = isoStr.split('T');
        return {
          date: parts[0] || '',
          time: (parts[1] || '').replace('Z', '')
        };
      }

      const pad = n => String(n).padStart(2, '0');
      const year = d.getFullYear();
      const month = pad(d.getMonth() + 1);
      const day = pad(d.getDate());
      const hours = pad(d.getHours());
      const minutes = pad(d.getMinutes());
      const seconds = pad(d.getSeconds());

      const offsetMin = -d.getTimezoneOffset();
      const sign = offsetMin >= 0 ? '+' : '-';
      const offsetHours = Math.floor(Math.abs(offsetMin) / 60);
      const offsetMinutes = Math.abs(offsetMin) % 60;
      const tzString = `UTC${sign}${pad(offsetHours)}:${pad(offsetMinutes)}`;

      return {
        date: `${year}-${month}-${day}`,
        time: `${hours}:${minutes}:${seconds} (${tzString})`
      };
    }

    function parseToTimestamp(isoStr) {
      if (!isoStr) return 0;
      const d = new Date(isoStr);
      if (isNaN(d)) return 0;
      return d.getTime();
    }

    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function highlightMatch(str, query) {
      if (str == null) return '';
      const escaped = escapeHtml(String(str));
      if (!query) return escaped;
      const q = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const reg = new RegExp(q, 'ig');
      return escaped.replace(reg, m => `<mark>${m}</mark>`);
    }
  </script>
</body>
</html>
